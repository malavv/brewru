<link rel="import" href="../bower_components/polymer/polymer.html">

<polymer-element name="recipe-newstep" attributes="builder" hidden>
  <script>
  var
    Menu,
    Steps = [
      {name: 'Add Ingredient', toString: byName},
      {name: 'Heating', toString: byName},
      {name: 'Splitting', toString: byName},
      {name: 'Merging', toString: byName},
      {name: 'Create Ingredient', toString: byName},
      {name: 'Ferment', toString: byName}
    ];

  function byName() {
    return this.name;
  }

  function StepState() {
    this.name = null;
    this.ingredient = null;
    this.type = null;
  };

  function StepBuilder(step) {
    this.step = step;
    this.ingredient;
    this.timing;
    this.qty;
  }

  function registerType(state, data) {
    state.type = data.selected.name;
    return state;
  }
  function registerName(state, data) {
    state.name = data.value;
    return state;
  }
  function registerIngredient(state, data) {
    state.ingredient = data.ingredient;
    state.qty = {value: data.value, unit: data.unit};
    return state;
  }

  Polymer('recipe-newstep', {
    isChoosing: false,

    ready: function() {
      require(['base/bus'], this.onReady.bind(this));
    },
    onReady: function(bus) {
      window.bus.register(this, 'CreateStep');
    },
    onCreateStep: function(data) {
      if (this.isChoosing) return;
      this.isChoosing = true;
      this.onStateMachine(new StepState());
    },

    onStateMachine: function(state) {
      if (state.type === null) return this.askType(state);
      if (state.name === null) return this.askName(state);
      if (state.ingredient === null) return this.askIngredient(state);
      console.log('Needs a next step, here is the current state : ', state);
    },

    askType: function(state) {
      bus.evt2promise('AskMenu', Steps, 'AnswerMenu')
        .then(registerType.bind(this, state))
        .then(this.onStateMachine.bind(this));
    },
    askName: function(state) {
      bus.evt2promise('AskText', 'Task Name', 'AnswerText')
        .then(registerName.bind(this, state))
        .then(this.onStateMachine.bind(this));
    },
    askIngredient: function(state) {
      bus.evt2promise('AskIngredient', this.builder.ingredients.listAllIngredients(), 'AnswerIngredient')
        .then(registerIngredient.bind(this, state))
        .then(this.onStateMachine.bind(this));
    },

    onAnswerMenu: function(data) {
      switch (data.selected.name) {
        case 'Add Ingredient':
          this.onAddingIngredient();
          break;
      }
      this.isChoosing = false;
    },
    onAddingIngredient: function() {
      Menu.ask(this.builder.ingredients.listAllIngredients())
        .then(this.onChosenIngredient.bind(this, new StepBuilder('Add Ingredient')));
    },
    onChosenIngredient: function(stepBld, ingredient) {
      stepBld.ingredient = ingredient.selected;
      Menu.ask(['After', 'OnTrigger']).then(this.onChooseStep.bind(this, stepBld));
    },
    onChooseStep: function(stepBld, timing) {
      stepBld.timing = timing.selected;
      var steps = [];
      this.builder.recipe.reactors.forEach(function(reactor) {
        reactor.steps.forEach(function(step) {
          steps.push({
            reactor: reactor,
            step: step,
            toString: function() {
              return this.reactor.name + ' - ' + this.step.name;
            }
          });
        });
      });

      Menu.ask(steps).then(this.onStepChosen.bind(this, stepBld));
    },
    onStepChosen: function(stepBld, step) {
      stepBld.qty = prompt("Enter quantity");
      step.selected.reactor.addAfter(
        step.selected.step, stepBld
      );
    }
  });
  </script>
</polymer-element>