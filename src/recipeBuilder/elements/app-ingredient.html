<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/core-list/core-list.html">
<link rel="import" href="../bower_components/core-overlay/core-overlay.html">

<link rel="import" href="widget-units.html">
<link rel="import" href="widget-quantity.html">
<link rel="import" href="widget-list.html">

<polymer-element
    name="app-ingredient"
    horizontal center-justified layout>
  <template>
    <link rel="stylesheet" href="../css/app-ingredient.css">

    <div class="container" vertical layout hidden?={{test}}>
      <widget-list id="list" data="{{ingredients}}" selection="{{selection}}">
      </widget-list>
      <widget-quantity quantity="{{quantity}}"></widget-quantity>
    </div>
  </template>
  <script>
  Polymer('app-ingredient', {
    // Event Bus
    busEvt: {
      receive: 'AskIngredient',
      send: 'AnswerIngredient'
    },
    // Control
    selection: undefined,
    // Input
    ingredients: ["1", "2", "3", "4"],

    ready: function() { require(['base/bus', 'base/quantity'], this.onReady.bind(this)); },
    onReady: function(Bus, Quantity) {
      window.bus.register(this, this.busEvt.receive);
      this.quantity = new Quantity();
      this.setVisible(false);
    },

    onAskIngredient: function(data) {
      this.ingredients = data;
      this.setVisible(true);
    },

    valueChanged: function() { this.onStateChanged() },
    selectionChanged: function() { this.onStateChanged(); },
    onUnitSelected: function(e) { this.onStateChanged(); },
    onStateChanged: function() {
      var results = this.getResults();
      if (!this.isValid(results)) return;
      window.bus.broadcast(this.busEvt.send, results);
      this.reset();
      this.setVisible(false);
    },

    isValid: function(result) {
      result = result || this;
      return result.ingredient !== undefined && result.value !== '' && result.unit !== '';
    },
    getResults: function() {
      if (this.selection !== undefined)
        delete this.selection.selected;
      return {
        ingredient: this.selection,
        value: this.value,
        unit: this.unit
      };
    },
    sendResults: function() {
      window.bus.broadcast(this.busEvt.send, this.getResults());
      this.reset();
    },
    setVisible: function(isVisible) {
      this.hidden = !isVisible;
    },
    reset: function() {
      this.selection = undefined;
      // Input
      this.ingredients = [];
      // Results
      this.value = '';
      this.unit = '';
      this.$.value.value = '';
    }
  });
  </script>
</polymer-element>