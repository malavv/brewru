<link rel="import" href="polymer-require.html">

<link rel="import" href="../bower_components/core-list/core-list.html">
<link rel="import" href="../bower_components/core-overlay/core-overlay.html">

<link rel="import" href="widget-units.html">
<link rel="import" href="widget-quantity.html">
<link rel="import" href="widget-list.html">

<polymer-element
    name="app-ingredient"
    horizontal center-justified layout>
  <template>
    <link rel="stylesheet" href="../css/app-ingredient.css">

    <core-overlay id="overlay" vertical layout>
      <widget-list id="list" data="{{ingredients}}" selection="{{ingredient}}"></widget-list>
      <widget-quantity quantity="{{quantity}}"></widget-quantity>
    </core-overlay>
  </template>
  <script>
  Polymer.require('app-ingredient',
    ['base/bus', 'base/quantity'],
    function(Bus, Quantity) {
      return {
        // Event Bus
        busEvt: {
          receive: 'AskIngredient',
          send: 'AnswerIngredient'
        },
        ingredients: [],

        ingredient: undefined,
        quantity: undefined,

        ready: function() {
          window.bus.register(this, this.busEvt.receive);
          this.$.overlay.close();
        },

        onAskIngredient: function(data) {
          this.ingredients = data;
          this.$.overlay.open();
        },

        ingredientChanged: function() { this.onStateChanged(); },
        quantityChanged: function() { this.onStateChanged(); },
        onStateChanged: function() {
          var results = this.getResults();
          if (!this.isValid(results)) return;
          window.bus.broadcast(this.busEvt.send, results);
          this.$.overlay.close();
          this.reset();
        },

        isValid: function(result) {
          result = result || this;
          return result.ingredient !== undefined && result.quantity !== undefined;
        },
        getResults: function() {
          return {
            ingredient: this.ingredient,
            quantity: this.quantity
          };
        },
        sendResults: function() {
          window.bus.broadcast(this.busEvt.send, this.getResults());
          this.reset();
        },
        reset: function() {
          this.ingredients = [];
          this.ingredient = undefined;
          this.quantity = undefined;
        }
      };
  });
  </script>
</polymer-element>