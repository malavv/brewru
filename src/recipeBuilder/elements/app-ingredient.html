<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/core-list/core-list.html">

<link rel="import" href="widget-units.html">

<polymer-element
    name="app-ingredient"
    attributes="isHidden"
    horizontal center-justified layout
    >
  <template>
    <link rel="stylesheet" href="../css/app-ingredient.css">
    <div class="container" vertical layout hidden?={{test}}>
      <core-list data="{{ingredients}}" selection="{{selection}}">
        <template>
          <div class="choice {{ {selected: selected} | tokenList }}" horizontal layout>
            <div class="idx">{{index | toSingleCharIdx}}</div>
            <div class="message">{{model}}</div>
          </div>
        </template>
      </core-list>
      <div horizontal layout>
        <paper-input id="value" label="Quantity" committedValue="{{value}}" flex></paper-input>
        <widget-units unit="{{unit}}"></widget-units>
      </div>
    </div>
  </template>
  <script>
  Polymer('app-ingredient', {
    // Event Bus
    busEvt: {
      receive: 'AskIngredient',
      send: 'AnswerIngredient'
    },
    // Control
    selection: null,
    // Input
    ingredients: [],
    // Results
    ingredient: null,
    value: '',
    unit: '',

    ready: function() {
      var self = this;
      require(['base/bus'], function() {
        window.bus.register(self, self.busEvt.receive);
        self.setVisible(false);
      }
      );
    },
    onAskIngredient: function(data) {
      this.ingredients = data;
      this.setVisible(true);
    },
    valueChanged: function(oldValue, newValue) {
      var results = this.getResults();
      if (!this.isValid(results)) return;
      window.bus.broadcast(this.busEvt.send, results);
      this.reset();
      this.setVisible(false);
    },
    selectionChanged: function(oldValue, newValue) {
      if (oldValue !== undefined && oldValue.selected !== undefined) {
        delete oldValue.selected;
      }
      if (newValue !== undefined)
        newValue.selected = undefined;
      this.ingredient = newValue;
    },
    isValid: function(result) {
      result = result || this;
      return result.ingredient !== null && result.value !== '' && result.unit !== '';
    },
    getResults: function() {
      if (this.ingredient !== null)
        delete this.ingredient.selected;
      return {
        ingredient: this.ingredient,
        value: this.value,
        unit: this.unit
      };
    },
    sendResults: function() {
      window.bus.broadcast(this.busEvt.send, this.getResults());
      this.reset();
    },
    setVisible: function(isVisible) {
      this.hidden = !isVisible;
    },
    reset: function() {
      this.selection = undefined;
      // Input
      this.ingredients = [];
      // Results
      this.ingredient = null;
      this.value = '';
      this.unit = '';
    }
  });
  </script>
</polymer-element>