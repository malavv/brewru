<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/core-list/core-list.html">

<link rel="import" href="widget-units.html">

<polymer-element
    name="app-ingredient"
    horizontal center-justified layout
    >
  <template>
    <link rel="stylesheet" href="../css/app-ingredient.css">
    <div class="container" vertical layout hidden?={{test}}>
      <core-list data="{{ingredients}}" selection="{{selection}}">
        <template>
          <div class="choice {{ {selected: selected} | tokenList }}" horizontal layout>
            <div class="idx">{{index | toSingleCharIdx}}</div>
            <div class="message">{{model}}</div>
          </div>
        </template>
      </core-list>
      <div horizontal layout>
        <paper-input id="value" label="Quantity" committedValue="{{value}}" flex></paper-input>
        <widget-units unit="{{unit}}" on-unit-selected="{{onUnitSelected}}"></widget-units>
      </div>
    </div>
  </template>
  <script>
  Polymer('app-ingredient', {
    // Event Bus
    busEvt: {
      receive: 'AskIngredient',
      send: 'AnswerIngredient'
    },
    // Control
    selection: undefined,
    // Input
    ingredients: [],
    // Results
    value: '',
    unit: '',

    ready: function() { require(['base/bus'], this.onReady.bind(this)); },
    onReady: function() {
      window.bus.register(this, this.busEvt.receive);
      this.setVisible(false);
    },

    onAskIngredient: function(data) {
      this.ingredients = data;
      this.setVisible(true);
    },

    valueChanged: function() { this.onStateChanged() },
    selectionChanged: function() { this.onStateChanged(); },
    onUnitSelected: function(e) { this.onStateChanged(); },
    onStateChanged: function() {
      var results = this.getResults();
      if (!this.isValid(results)) return;
      window.bus.broadcast(this.busEvt.send, results);
      this.reset();
      this.setVisible(false);
    },

    isValid: function(result) {
      result = result || this;
      return result.ingredient !== undefined && result.value !== '' && result.unit !== '';
    },
    getResults: function() {
      if (this.selection !== undefined)
        delete this.selection.selected;
      return {
        ingredient: this.selection,
        value: this.value,
        unit: this.unit
      };
    },
    sendResults: function() {
      window.bus.broadcast(this.busEvt.send, this.getResults());
      this.reset();
    },
    setVisible: function(isVisible) {
      this.hidden = !isVisible;
    },
    reset: function() {
      this.selection = undefined;
      // Input
      this.ingredients = [];
      // Results
      this.value = '';
      this.unit = '';
      this.$.value.value = '';
    }
  });
  </script>
</polymer-element>